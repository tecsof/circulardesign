<div id="chartcontainer">
    <ul id="selector">
        
        <li class="title">Refine by:</li>

        <li class="title">Strategy</li>
        <li data-attr="Reuse" class="active" data-field="strategy">Design for Reuse</li>
        <li data-attr="Maintenance" data-field="strategy">Design for Maintenance</li>
        <li data-attr="Refurbishment" data-field="strategy">Design for Refurbishment</li>
        <li data-attr="Remanufacturing" data-field="strategy">Design for Remanufacturing</li>
        <li data-attr="Recycle" data-field="strategy">Design for Recycle</li>

        <li class="title">Loop</li>
        <li data-attr="LOOP 1" data-field="LOOP">First loop</li>
        <li data-attr="LOOP N" data-field="LOOP">Loop X</li>
        <li data-attr="LAST LOOP" data-field="LOOP">Last loop</li>

        <li class="title">Applies to</li>
        <li data-attr="Materials" data-field="APPLIES_TO">Materials</li>
        <li data-attr="Components" data-field="APPLIES_TO">Components</li>
        <li data-attr="Products" data-field="APPLIES_TO">Products</li>
        <li data-attr="Processes" data-field="APPLIES_TO">Processes</li>
        <li data-attr="Systems" data-field="APPLIES_TO">Systems</li>

        <span class="searchbox"><hr>
            Search by product<br>
            <input id="searchby" placeholder="cars, chairs, etc..."><br>
            <a onclick="searchDb()" href="#" class="minibutton">SEARCH</a>
        </span>
    </ul>
    <div id="chartdiv" class="hidden"></div>
    <div id="panel"></div>
    <div id="project"><div class="opener"><img src="http://www.circulardesign.it/wp-content/uploads/2019/04/kisspng-arrow-computer-icons-circle-clip-art-left-arrow-5ac00ad08158b9.5867764615225351205298.png"></div><div class="cont"></div></div>
    <div id="legend"></div>
</div>
<!-- Styles -->
<style>
    #project{width:300px;height:100%;position: fixed;background: white;z-index: 1000;top:0px;right:-300px;bottom:0px;-webkit-transition: all .6s ease;padding:20px;padding-top:100px;}
    #project.open{right:0px;}
    #project ul{list-style: none;}
    #project ul li{cursor: pointer;}
    #project hr{width: 100%;
        margin: 0px;
        margin-top: 50px;
        margin-bottom: 20px;}
    #project input{width:100%;}
    #project div.opener{width:30px;height:30px;position:absolute;top:50%;left:-50px;cursor:pointer;-webkit-transition: all .6s ease;}
    #project div.opener img{max-width:100%;max-height:100%;}
    #project.open div.opener{-webkit-transform: rotate(180deg);}
    #projectname.error{border:1px solid red;}
    #project ul li .remove {
        float: right;
    }
    #project ul li {
        border-bottom: 1px solid #f0f0f0;
        padding: 5px 0px;
        color: black;
    }
    #project ul li span:hover{
        text-decoration: underline;
    }

    #chartcontainer a.minibutton{
        background: black;
        padding: 2px 5px;
        color: white;
        display: inline-block;
        font-size: 12px;
        font-weight: bolder;
        margin: 5px 0px;
    }
    #chartcontainer a.minibutton.active{
        background: white;
        color: black;
    }

    header#masthead{position:relative !important; top:0px !important;}
    header{background:transparent !important;}
    header.page-header{display:none !important;}
    #chartdiv {
        width: 100%;
        height: 700px;
        float:left;
        -webkit-transition: width .6s ease;
    }
    h1 {
        margin-top: 100px !important;
    }
    #panel{
        width:0%;
        height:700px;
        float:left;
        overflow-y:auto;
        overflow-x:hidden;
        -webkit-transition: width .6s ease;
        position: relative;
        padding-bottom: 150px;
    }
    #panel button.add_project{
        position: fixed;
        bottom: 70px;
        left: 70%;
        margin-left: -100px;
    }

    #panel .content a{
        text-decoration:underline;
    }

    #panel .small_image {
        width: 100%;
        height: 110px;
        background-size: contain;
        background-position: left center;
        background-repeat: no-repeat;
        margin:5px;
    }
    #panel a.close, #project a.close{
        font-weight: bold;
        position: absolute;
        left:0px;
        top:0px;
        font-size:18px;
        width:20px;
        height:20px;
        border:1px solid black;
        text-align: center;
        line-height: 15px;
    }
    #project a.close{top: 50px;left:10px;}

    #chartcontainer.open #chartdiv{
        width:50%;
    }
    #chartcontainer.open #panel{
        width:45%;
        margin-left:5%;
    }

    ul#selector{
        position: absolute;
        left: 0px;
        top: 0px;
        margin-top: 0px;
        height: 700px;
        list-style: none;
        padding: 10px;
        z-index:1;
        background: #f1ee2ead;
    }
    ul#selector:hover{z-index: 10;}

    ul#selector li {
        font-size: 14px;
        color: black;
        cursor: pointer;
        text-indent: 10px;
    }

    #selector li.title {
        font-weight: bold;
        text-indent: 0px;
        cursor: default !important;
    }

    ul#selector li:hover{
        text-decoration: underline;
    }
    ul#selector li.title:hover{
        text-decoration: none;
    }
    ul#selector li.active{
        font-weight: bold;
    }

    ul#selector span.searchbox hr{
        margin: 0px;
        margin-top: 10px;
        margin-bottom: 10px;
    }
    ul#selector span.searchbox a{
        font-size: 12px;
        font-weight: bold;
    }
    ul#selector span.searchbox input{
        padding: 5px;
        background: #e8e750;
        border: 1px solid black;
    }

    g tspan{fill:black !important;}

    @media screen and (max-width: 1200px) {
        #panel a.close{left:50%;margin-left:-10px;
            margin-top: 20px;}
        .container.container-medium{padding:0px;}
        #panel{
            width:100%;
            height:auto;
            margin:0px;
        }
        ul#selector {
            position: relative;
            top: 0px;
            margin: 0px;
            width: 100%;
            text-align: center;
            height: auto;
        }
        div#chartdiv {
            height: 400px;
        }
        #chartcontainer.open #chartdiv{
            width:100%;
        }
        #chartcontainer.open #panel{
            width:100%;
            margin:0px;
            padding:10px;
            padding-bottom: 100px;
        }
        #panel button.add_project {
            bottom: 0px;
            left: 0px;
            width: 100%;
            margin: 0px;
        }
    }

    #panel li {
        list-style: none;
        color: black;
    }
            

    div#legend ul {
        list-style: none;
        width: 300px;
        display: inline-block;
        color: black;
    }
    div#legend ul div {
        width: 10px;
        height: 10px;
        float: left;
        margin-right: 5px;
    }
    div#legend ul li {
        text-align: left;
        color:black;
        font-size:12px;
        line-height: 8px;
    }
    div#legend {
        width: 100%;
        display: inline-block;
        text-align: left;
        padding-left:10px;
    }

    div#chartdiv.hidden {
        opacity: 0.1;
        pointer-events: none;
        filter: grayscale(100%);
    }
    #graph_messages{
        z-index: 1;
        position: absolute;
        top: 0px;
        left: 20%;
        bottom: 0px;
        right: 20%;
        text-align: center;
        vertical-align: middle;
        font-size: 12px;
        font-weight: bold;
    }

    #content .container{
        max-width: none !important;
        width: 100%;
        margin: 0px;
        padding: 0px;
    }
</style>

<!-- Resources -->
<script src="https://www.amcharts.com/lib/4/core.js"></script>
<script src="https://www.amcharts.com/lib/4/charts.js"></script>
<script src="https://www.amcharts.com/lib/4/plugins/sunburst.js"></script>
<script src="https://www.amcharts.com/lib/4/themes/material.js"></script>
<script src="https://www.amcharts.com/lib/4/themes/animated.js"></script>

<!-- Chart code -->
<script>


    var types={};
    types={
        "business":{color:"#E6883C",label:"Business & Network"},
        "resource":{color:"#AF7DEB",label:"Resources use & production"},
        "logistics":{color:"#C94D8B",label:"Forward logistic"},
        "sale":{color:"#5386D3",label:"Sale"},
        "use":{color:"#7BE3CD",label:"Use & operation"},
        "service":{color:"#64D069",label:"Service & maintenance"},
        "reverse":{color:"#C8D454",label:"Reverse logistic"},
        "recovery":{color:"#a65e2e",label:"Recovery"},
        "default":{color:"#000",label:""},
        "highlight":{color:"#f7f6b9",label:""},
        "off":{color:"#cccccc",label:""},
    };



    const pSBC=(p,c0,c1,l)=>{
        let r,g,b,P,f,t,h,i=parseInt,m=Math.round,a=typeof(c1)=="string";
        if(typeof(p)!="number"||p<-1||p>1||typeof(c0)!="string"||(c0[0]!='r'&&c0[0]!='#')||(c1&&!a))return null;
        if(!this.pSBCr)this.pSBCr=(d)=>{
            let n=d.length,x={};
            if(n>9){
                [r,g,b,a]=d=d.split(","),n=d.length;
                if(n<3||n>4)return null;
                x.r=i(r[3]=="a"?r.slice(5):r.slice(4)),x.g=i(g),x.b=i(b),x.a=a?parseFloat(a):-1
            }else{
                if(n==8||n==6||n<4)return null;
                if(n<6)d="#"+d[1]+d[1]+d[2]+d[2]+d[3]+d[3]+(n>4?d[4]+d[4]:"");
                d=i(d.slice(1),16);
                if(n==9||n==5)x.r=d>>24&255,x.g=d>>16&255,x.b=d>>8&255,x.a=m((d&255)/0.255)/1000;
                else x.r=d>>16,x.g=d>>8&255,x.b=d&255,x.a=-1
            }return x};
        h=c0.length>9,h=a?c1.length>9?true:c1=="c"?!h:false:h,f=pSBCr(c0),P=p<0,t=c1&&c1!="c"?pSBCr(c1):P?{r:0,g:0,b:0,a:-1}:{r:255,g:255,b:255,a:-1},p=P?p*-1:p,P=1-p;
        if(!f||!t)return null;
        if(l)r=m(P*f.r+p*t.r),g=m(P*f.g+p*t.g),b=m(P*f.b+p*t.b);
        else r=m((P*f.r**2+p*t.r**2)**0.5),g=m((P*f.g**2+p*t.g**2)**0.5),b=m((P*f.b**2+p*t.b**2)**0.5);
        a=f.a,t=t.a,f=a>=0||t>=0,a=f?a<0?t:t<0?a:a*P+t*p:0;
        if(h)return"rgb"+(f?"a(":"(")+r+","+g+","+b+(f?","+m(a*1000)/1000:"")+")";
        else return"#"+(4294967296+r*16777216+g*65536+b*256+(f?m(a*255):0)).toString(16).slice(1,f?undefined:-2)
    }


    function complementarycolor(temprgb) {
        var temphsv = RGB2HSV({r:parseInt("0x"+temprgb.substr(1,2)),g:parseInt("0x"+temprgb.substr(3,2)),b:parseInt("0x"+temprgb.substr(4,2))});
        temphsv.hue = HueShift(temphsv.hue, 150.0);
        var c=HSV2RGB(temphsv);
        return "rgb(" +c.r+","+c.g+","+c.b+")";
    }

    function RGB2HSV(rgb) {
        hsv = new Object();
        max=max3(rgb.r,rgb.g,rgb.b);
        dif=max-min3(rgb.r,rgb.g,rgb.b);
        hsv.saturation=(max==0.0)?0:(100*dif/max);
        if (hsv.saturation==0) hsv.hue=0;
        else if (rgb.r==max) hsv.hue=60.0*(rgb.g-rgb.b)/dif;
        else if (rgb.g==max) hsv.hue=120.0+60.0*(rgb.b-rgb.r)/dif;
        else if (rgb.b==max) hsv.hue=240.0+60.0*(rgb.r-rgb.g)/dif;
        if (hsv.hue<0.0) hsv.hue+=360.0;
        hsv.value=Math.round(max*100/255);
        hsv.hue=Math.round(hsv.hue);
        hsv.saturation=Math.round(hsv.saturation);
        return hsv;
    }

    // RGB2HSV and HSV2RGB are based on Color Match Remix [http://color.twysted.net/]
    // which is based on or copied from ColorMatch 5K [http://colormatch.dk/]
    function HSV2RGB(hsv) {
        var rgb=new Object();
        if (hsv.saturation==0) {
            rgb.r=rgb.g=rgb.b=Math.round(hsv.value*2.55);
        } else {
            hsv.hue/=60;
            hsv.saturation/=100;
            hsv.value/=100;
            i=Math.floor(hsv.hue);
            f=hsv.hue-i;
            p=hsv.value*(1-hsv.saturation);
            q=hsv.value*(1-hsv.saturation*f);
            t=hsv.value*(1-hsv.saturation*(1-f));
            switch(i) {
                case 0: rgb.r=hsv.value; rgb.g=t; rgb.b=p; break;
                case 1: rgb.r=q; rgb.g=hsv.value; rgb.b=p; break;
                case 2: rgb.r=p; rgb.g=hsv.value; rgb.b=t; break;
                case 3: rgb.r=p; rgb.g=q; rgb.b=hsv.value; break;
                case 4: rgb.r=t; rgb.g=p; rgb.b=hsv.value; break;
                default: rgb.r=hsv.value; rgb.g=p; rgb.b=q;
            }
            rgb.r=Math.round(rgb.r*255);
            rgb.g=Math.round(rgb.g*255);
            rgb.b=Math.round(rgb.b*255);
        }
        return rgb;
    }

    //Adding HueShift via Jacob (see comments)
    function HueShift(h,s) {
        h+=s; while (h>=360.0) h-=360.0; while (h<0.0) h+=360.0; return h;
    }

    //min max via Hairgami_Master (see comments)
    function min3(a,b,c) {
        return (a<b)?((a<c)?a:c):((b<c)?b:c);
    }
    function max3(a,b,c) {
        return (a>b)?((a>c)?a:c):((b>c)?b:c);
    }






    var graph_config={
        min_fontsize:7,
        max_fontsize:10,
        title_size:20,
        line_break:12
    };

    if(screen.width<1200){
        graph_config={
            min_fontsize:5,
            max_fontsize:6,
            title_size:20,
            line_break:9
        };
    }

    function wrapup(t){
        if(t.length==0) return null;
        if(t.length>graph_config.line_break){
            var br = new RegExp('(.{' + graph_config.line_break + '}[^ ]* )','g')
            var broken = t.replace(br, "$1\n");
            t=broken;
        }
        return t;
    }


    function am4themes_blackText(target) {
        if (target instanceof am4core.InterfaceColorSet) {
            target.setFor("text", am4core.color("#000000"));
            target.setFor("fill", am4core.color("#000000"));
        }
    }


    function searchwhere(X3){

        var q=[];
        var s="https://sheetdb.io/api/v1/x9j328uv1qu2z/search?sheet=%SHEET%&X3=*" + X3 + "*&casesensitive=false";
            jQuery("#chartcontainer #selector li").each(function(){
                q.push({
                    url:s.replace("%SHEET%",jQuery(this).attr("data-attr")),
                    sheet: jQuery(this).attr("data-attr")
                    });
            });
        
        for(var i=0;i<q.length;i++) {
            var found="";
            jQuery.ajax({
                url: q[i].url,
                success: function (result) {
                    if (result.length>0) found=q[i].sheet;
                },
                async: false
            });
            
            if(found!="") return found;
        }

    }

    am4core.useTheme(am4themes_material);
    //am4core.useTheme(am4themes_animated);
    am4core.useTheme(am4themes_blackText);

    var chart = am4core.create("chartdiv",
        am4plugins_sunburst.Sunburst);

    var deeplink=null;

    var dbsheet="";
    dbsheet=jQuery("#chartcontainer #selector li[data-field='strategy']:first").attr("data-attr");
    if(document.location.hash !=null && document.location.hash !="" && document.location.hash.substr(0,4)!="#dl:" && jQuery("#chartcontainer #selector li[data-attr='" + document.location.hash.substr(1) + "'][data-field='strategy']").length>0){
        dbsheet=document.location.hash.substr(1);
        jQuery("#chartcontainer #selector li[data-field='strategy']").removeClass("active");
        jQuery("#chartcontainer #selector li[data-attr=" + document.location.hash.substr(1) + "][data-field='strategy']").addClass("active");
    }

    if(document.location.hash !=null && document.location.hash !="" && document.location.hash.substr(0,4)=="#dl:"){
        jQuery("#chartcontainer #selector li[data-field='strategy']").removeClass("active");
        deeplink=decodeURI(document.location.hash.substring(4));

        dbsheet=searchwhere(deeplink);
        if(dbsheet){
            jQuery("#chartcontainer #selector li[data-field='strategy']").removeClass("active");
            jQuery("#chartcontainer #selector li[data-attr=" + dbsheet + "][data-field='strategy']").addClass("active");
        }


    }

    jQuery("#chartcontainer #selector li[data-field='strategy']").click(function(){
        jQuery("#chartcontainer #selector li[data-field='strategy']").removeClass("active");
        jQuery(this).addClass("active");
        dbsheet=jQuery(this).attr("data-attr");
        initGraph();
    });

    jQuery("#chartcontainer #selector li[data-field='LOOP']").click(function(){
        jQuery(this).toggleClass("active");
        initGraph();
    });
    jQuery("#chartcontainer #selector li[data-field='APPLIES_TO']").click(function(){
        jQuery(this).toggleClass("active");
        initGraph();
    });


    function formatSerie(lt, s){

        lt.fillOpacity = 1;
        lt.hiddenInLegend = true;
        lt.slices.template.tooltipText = "{category}";
        lt.slices.template.cursorOverStyle = am4core.MouseCursorStyle.pointer;
        lt.labels.template.text = "[color:black bold" + (s!=null ? " font-size: " + s :"") + "]{category}[/]";
        lt.chartCursor = false;

        lt.slices.template.fillOpacity = 1;


        var axisTooltip = lt.tooltip;
        axisTooltip.background.strokeWidth = 0;
        axisTooltip.background.cornerRadius = 0;
        axisTooltip.background.pointerLength = 2;
        axisTooltip.dy = 5;

        var dropShadow = new am4core.DropShadowFilter();
        dropShadow.dy = 0;
        dropShadow.dx = 0;
        dropShadow.opacity = 0;
        axisTooltip.filters.push(dropShadow);

        var hs = lt.slices.template.states.getKey("hover");
        hs.properties.scale = 1;
        hs.properties.fillOpacity = 0.8;


        lt.slices.template.events.on("hit", function (dati) {
            showPanel(dati.target.dataItem.dataContext.name);
        }, this);
    }


    function searchDb(){

        if(jQuery("#searchby").val().trim().length>0) {
            jQuery("#chartcontainer #selector li[data-field='strategy']").removeClass("active");

            var q=[];
            var s="https://sheetdb.io/api/v1/x9j328uv1qu2z/search?sheet=%SHEET%&PRODUCT-TAGS=*" + jQuery("#searchby").val().trim() + "*&casesensitive=false";
            jQuery("#chartcontainer #selector li[data-field='strategy']").each(function(){
                q.push(s.replace("%SHEET%",jQuery(this).attr("data-attr")));
            });

            initGraph(q);
        }
    }


    function initLegend(){

        var ul="";
        for (var type in types) {
            if (types.hasOwnProperty(type) && types[type].label!="") {
                ul+="<li><div style='background-color:" + types[type].color + "'></div> " + types[type].label + "</li>";
            }
        }

        jQuery("#legend").html("<ul>"+ul+"</ul>")

    }

    function dataInterface(data){
        var d = [];
        var papa = "";
        var figlio = "";
        var nipote = "";
        var colore_figlio="";
        var complimentary="";
        for (var i = 0; i < data.length; i++) {
            if (data[i].X1 != papa) {
                papa = data[i].X1;
                d.push({
                    name: wrapup(papa),
                    color: "#f1ef2e",
                    children: []
                });
            }
            if (data[i].X1 != data[i].X2) {
                if (data[i].X2 != figlio) {
                    figlio = data[i].X2;
                    d[d.length - 1].children.push({
                        name: wrapup(figlio),
                        color: types[data[i].TYPE || "default"].color,
                        children: []
                    });
                }
                if (data[i].X2 != data[i].X3) {
                    if (data[i].X3 != nipote) {
                        nipote = data[i].X3;
                        d[d.length - 1].children[d[d.length - 1].children.length - 1].children.push({
                            name: wrapup(nipote),
                            color: pSBC(0.2,types[data[i].TYPE || "default"].color),
                            value: wrapup(nipote) != null ? 1 : 0
                        });
                    }
                }
            }
        }
        return d;
    }

    var masterData = [];
    var goRender = 0;

    function initGraph(q) {

        jQuery("#graph_messages").remove();

        initLegend();
        try{
            chart.series.removeIndex(
                chart.series.indexOf(0)
            ).dispose();
            chart.series.removeIndex(
                chart.series.indexOf(1)
            ).dispose();
            chart.series.removeIndex(
                chart.series.indexOf(2)
            ).dispose();
        }catch(e){}

        document.location.hash = dbsheet;
        jQuery("#panel").html("");
        jQuery("#chartcontainer").removeClass("open");

        masterData=[];
        var d = [];
        var queries=[];

        if(q==null || q=="") {

            if(jQuery("#chartcontainer #selector li[data-field='LOOP'].active").length>0 || jQuery("#chartcontainer #selector li[data-field='APPLIES_TO'].active").length>0){
                
                var s="https://sheetdb.io/api/v1/x9j328uv1qu2z/search_or?sheet=" + dbsheet;
                
                jQuery("#chartcontainer #selector li[data-field='LOOP'].active").each(function(){
                    s+="&LOOP[]=*" + jQuery(this).attr("data-attr") + "*";
                });
                jQuery("#chartcontainer #selector li[data-field='APPLIES_TO'].active").each(function(){
                    s+="&APPLIES_TO[]=*" + jQuery(this).attr("data-attr") + "*";
                });
                s+="&casesensitive=false";
                queries.push(s);
            }else{
                queries.push("https://sheetdb.io/api/v1/x9j328uv1qu2z?sheet=" + dbsheet);
            }

            graph_config.title_size = 20;
        }
        else queries=q;

        if(queries.length>1) graph_config.title_size=10;

        jQuery("#chartdiv").addClass("hidden");
        jQuery("#chartdiv").before("<div id='graph_messages'>RENDERING</div>");

        goRender = queries.length;
        for(var i=0;i<queries.length;i++) {
            jQuery.getJSON(queries[i], function (data) {
                goRender--;
                var md=masterData.concat(data);
                masterData=md;
                if(goRender==0){renderGraph();}
            });
        }


    }

    window.setInterval(function(){
        if(needCheckReadiness){
            if(chart.seriesTemplates.getKey(2).isReady() && chart.seriesTemplates.getKey(1).isReady() && chart.seriesTemplates.getKey(0).isReady()){
                window.setTimeout(function(){
                    jQuery("#chartdiv").removeClass("hidden");
                    jQuery("#graph_messages").remove();
                },1000);
            }
            needCheckReadiness=false;
        }
    },500);

    var needCheckReadiness=false;

    function renderGraph(){

        if(masterData.length==0){
            needCheckReadiness=false;
            jQuery("#graph_messages").remove();
            jQuery("#chartdiv").before("<div id='graph_messages'>NOT FOUND</div>");
            return false;
        }

        chart.data = dataInterface(masterData);
        needCheckReadiness=true;

        chart.colors.step = 1;
        chart.fontSize = graph_config.max_fontsize;
        chart.fontWeight = 800;
        chart.innerRadius = am4core.percent(0);
        chart.radius = am4core.percent(100);

        // define data fields
        chart.dataFields.value = "value";
        chart.dataFields.name = "name";
        chart.dataFields.children = "children";
        chart.dataFields.color = "color";
        chart.chartCursor = false;

        needCheckReadiness=true;
        var level0SeriesTemplate = new am4plugins_sunburst.SunburstSeries();
        level0SeriesTemplate.strokeWidth=0
        chart.seriesTemplates.setKey("0", level0SeriesTemplate)
        formatSerie(level0SeriesTemplate, graph_config.title_size + "px");

        needCheckReadiness=true;
        var level1SeriesTemplate = new am4plugins_sunburst.SunburstSeries();
        level1SeriesTemplate.strokeWidth=0
        chart.seriesTemplates.setKey("1", level1SeriesTemplate)
        formatSerie(level1SeriesTemplate);

        needCheckReadiness=true;
        var level2SeriesTemplate = new am4plugins_sunburst.SunburstSeries();
        level2SeriesTemplate.strokeWidth=0
        chart.seriesTemplates.setKey("2", level2SeriesTemplate)
        formatSerie(level2SeriesTemplate);

        if(deeplink){
            openPanel(deeplink);
            deeplink="";
        }
    }


    initGraph();

    function formatlines(t){
        return t.replace(/\n/g, '<br/>');
    }

    function formatimage(i){
        if(i==null || i==""){ return "";}
        return "<div style=\"background-image:url('" + i + "');\" class='small_image'></div>";
    }

    function formathow(t){
        if(t==null || t==""){ return "";}
        return "<li><h3>What can it do?</h3>" + formatlines(t) + "</li>";
    }
    function formatcases(t, l, i, id, container){

        var h="";
        if(id!="" && id!=null && id!="0" && container==null){
            jQuery.ajax({
                url: "https://sheetdb.io/api/v1/x2gcpmbdwud9u/search?ID=" + id,
                success: function (result) {
                    if (result.length>0) {
                        i=result[0]["HERO IMAGE"];
                        t=result[0]["CASE STUDY"];
                        l=result[0]["LINKS"];
                        formatcases(t,l,i,id,"casestudiesbox")
                    }
                },
                async: true
            });
        }

        l=formatcaselinks(l);
        i=formatimage(i);
        if(((t==null || t=="") && l=="" && i=="") && (id==null || id=="")) { return "";}
        var html="<h3>Case studies</h3>" + i + formatlines(t) + "<br/>" + l + "<br/><br/>" + formatcaselink(id)
        
        if(container!=null){
            jQuery("#" + container).html(html)
        }
        else{
            return "<li id='casestudiesbox'>" + html + "</li>";
        }
    }
    function formatcaselinks(t){
        if(t==null || t==""){ return "";}
        try {
            var l = t.split("\n");
            var r = [];
            for (var i = 0; i < l.length; i++) r.push("<a href='" + l[i].split(";")[0] + "' class=extlink>" + (l[i].split(";")[1] || l[i].split(";")[0]) + "</a> <small>(external link)</small>");
            return formatlines(r.join("<br>"));
        }catch(e){return "";}
    }
    function formatcaselink(id){
        if(id==null || id==""){ return "";}
        try {
            return "<a href='/case-studies/#dl:" + id + "' class=extlink>Open case study page</a>";
        }catch(e){return "";}
    }
    function formatreferences(t){
        if((t==null || t=="")) { return "";}
        return "<li><h3>References</h3>" + formatlines(t)+ "</li>";
    }
    function formatQA(t){
        if((t==null || t=="")) { return "";}
        return "<li><h3>What questions to ask?</h3>" + formatlines(t)+ "</li>";
    }
    function formatchar(t){
        if((t==null || t=="")) { return "";}
        return "<li><h3>When is it used?</h3>" + formatlines(t)+ "</li>";
    }
    function formatuse(t){
        if((t==null || t=="")) { return "";}
        return "<li><h3>How is it used?</h3>" + formatlines(t)+ "</li>";
    }

    function relationships(t){
        if((t==null || t=="")) { return "";}
        try {
            var l = t.split(",");
            var r = [];
            for (var i = 0; i < l.length; i++) r.push("<a href='#' data-attr='" + l[i] + "' class='crosslinks'>" + l[i] + "</a> ");
            return "Indirect DfX relationship: "+ formatlines(r.join(" | ") + " <a href='#' class='showcrosslinks minibutton'>show relationships</a>");
        }catch(e){return "";}
    }

    function print(){
        window.open("/design-for-x-print");
    }

    function openPanel(s,d){
        showPanel(s,d);
    }

    function renderActiveProject() {
        var html = "<h2>" + project.activeSession.name + "</h2><ul>";

        var cindex=0;

        for (var i = 0; i < project.activeSession.items.length; i++) {
            cindex+=parseInt(project.activeSession.items[i].CIRCULARITY_INDEX ||0);
            html += "<li data-attr='" + project.activeSession.items[i].X3 + "'><span>" + project.activeSession.items[i].X3 + "</span> <b class='remove'>x</b></li>";
        }
        project.activeSession.cindex=Math.round((cindex/project.activeSession.items.length)* 100) / 100;
        html += "</ul><span>Circularity Index " + project.activeSession.cindex + "</span><br><a onclick='saveAndClose()' href='#' class='minibutton'>SAVE AND CLOSE PROJECT</a><br><a onclick='print()' href='#' class='minibutton'>PRINT MANUAL</a>";
        jQuery("#project .cont").html(html);
        jQuery("#project li span").click(function(){

            var found=null;
            for(var i=0;i<project.activeSession.items.length;i++){
                if(project.activeSession.items[i].X3==jQuery(this).parent().attr("data-attr")) {found=i;break;}
            }

            openPanel(jQuery(this).parent().attr("data-attr"),project.activeSession.items[found]);
        });


        jQuery("#project li .remove").click(function(){
            var s=jQuery(this).parent().attr("data-attr");
            var remove=null;
            for(var i=0;i<project.activeSession.items.length;i++){
                if(project.activeSession.items[i].X3==s) {remove=i;break;}
            }
            var removed = project.activeSession.items.splice(remove,1);

            localDb.setItem("projectObj",JSON.stringify(project));
            renderActiveProject();
        });

    }

    function saveAndClose(){
        var update=null;
        if(project.history==null){ project.history=[];}
        else{
            for(var i=0;i<project.history.length;i++){
                if(project.history[i].id==project.activeSession.id) {update=i;break}
            }
        }
        if(update!=null)
            project.history[update]=project.activeSession;
        else
            project.history.push(project.activeSession);

        project.activeSession=null;
        localDb.setItem("projectObj",JSON.stringify(project));
        createNewProject();
    }

    function initProject(){
        project=JSON.parse(localDb.getItem("projectObj") || "{}");
        if(project!=null && project.activeSession!=null){
            renderActiveProject();
        }
        else{createNewProject();}
    }

    var localDb = window.localStorage;
    var project={};

    initProject();
    jQuery("#project .opener").click(function(){
        jQuery("#project").toggleClass("open");
    });

    function addItemToProject(){
        project.activeSession.items.push(project.activePanel);
        localDb.setItem("projectObj",JSON.stringify(project));
        renderActiveProject();
    }

    function saveNewProject(){
        if(jQuery("#project #projectname").val()!="") {

            var d = new Date();
            project.activeSession = {
                id: d.getTime(),
                name: jQuery("#project #projectname").val(),
                items: []
            };
            jQuery("#project").addClass("active");
            addItemToProject();
        }else{
            jQuery("#project #projectname").addClass("error");
        }
    }
    function createNewProject() {
        var html = "<h2>Create project</h2>" +
            "<input id='projectname' placeholder='Project name'/><br>" +
            "<a onclick='saveNewProject()' class='minibutton' href='#'>CREATE NEW PROJECT</a>";
        if (project.history != null && project.history.length > 0) {
            html += "<hr>or select an archived project <ul>";
            for (var i = 0; i < project.history.length; i++)
                html += "<li data-attr='" + project.history[i].id + "'><span>" + project.history[i].name + " (" + project.history[i].cindex + ")</span> <b class='remove'>x</b></li>";
            html += "</ul>";
        }
        jQuery("#project .cont").html(html);
        jQuery("#project li span").click(function(){
            var h=null;
            var s=jQuery(this).parent().attr("data-attr");
            for(var i=0;i<project.history.length;i++){
                if(project.history[i].id==s) {h=project.history[i];break;}
            }
            project.activeSession=h;
            localDb.setItem("projectObj",JSON.stringify(project));
            initProject();
        });
        jQuery("#project li .remove").click(function(){
            var s=jQuery(this).parent().attr("data-attr");
            var remove=null;
            for(var i=0;i<project.history.length;i++){
                if(project.history[i].id==s) {remove=i;break;}
            }
            var removed = project.history.splice(remove,1);
            project.activeSession=null;
            localDb.setItem("projectObj",JSON.stringify(project));
            initProject();
        });
    }


    function adaptData(d, extended){
        var myTempData=JSON.parse(JSON.stringify(masterData));
        if(d){
            var s=d.X3.replace("\n","").toLocaleLowerCase().trim();
            for(var i=0;i<masterData.length;i++)
                if((masterData[i]!=null && masterData[i].X3!=null && masterData[i].X3.toLocaleLowerCase()==s) || ((extended || false) && d.DFX_RELATIONSHIP.indexOf(masterData[i].X3)>-1)) {
                    myTempData[i].TYPE="highlight";
                }
        }
        chart.data=dataInterface(myTempData);
    }

    function showPanel(field, mdataOverride){
        var d=null;
        if(mdataOverride==null){
            d=findCR(field);
        }
        else{d=mdataOverride;}

        if(d!=null){

            adaptData(d);

            jQuery("#panel").html("<a href='#' class='close'>x</a><div class='content'><h2>" + d.X3 + "</h2>" +
                "<li>" + formatlines(d.WHY) + "</li>" +
                formathow(d.HOW) +
                formatuse(d["USE"])+
                formatchar(d["CHARACTERISTICS"]) +
                formatQA(d["QUESTIONS TO ANSWER"]) +
                formatcases("","", "", d["CASE_STUDY_ID"]) +
                formatreferences(d["REFERENCES"]) +
                relationships(d.DFX_RELATIONSHIP) +
                "</div><li><button class='add_project'>Add to project</button></li>"
            );
            jQuery("#chartcontainer").addClass("open");
            jQuery("#panel .content a.extlink").attr("target","_blank");
            chart.fontSize = graph_config.min_fontsize;

            jQuery("#panel a.crosslinks").click(function(){
                openPanel(jQuery(this).attr("data-attr"));
            });

            jQuery("#panel a.showcrosslinks").click(function(){
                if(jQuery(this).hasClass("active")){
                    jQuery(this).removeClass("active");
                    adaptData();
                }
                else{
                    jQuery(this).addClass("active");
                    adaptData(d,true);
                }

                
            });
            
            jQuery("#panel a.close").click(function(){
                jQuery("#panel").html("");
                project.activePanel=null;
                jQuery("#chartcontainer").removeClass("open");
                chart.fontSize = graph_config.max_fontsize;
            });

            project.activePanel=d;
            jQuery("#panel button.add_project").click(function(){
                if(project.activeSession==null){
                    createNewProject();
                    jQuery("#project").addClass("open");
                }else {
                    addItemToProject();
                    jQuery("#project").addClass("open");
                }
            });
        }
    }


    function findCR(cr){
        cr=cr.replace(/\n/g,"").toLocaleLowerCase().trim();
        for(var i=0;i<masterData.length;i++)
            if(masterData[i]!=null && masterData[i].X3!=null && masterData[i].X3.toLocaleLowerCase()==cr) return masterData[i];

        return null;
    }

</script>